rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 1. User & Parent Profiles (Owner-only)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /parents/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 2. Children (Only the parent who added them)
    match /children/{childId} {
      allow read: if request.auth != null && (resource == null || resource.data.parentId == request.auth.uid);
      allow write: if request.auth != null && (
        (resource == null && request.resource.data.parentId == request.auth.uid) || 
        (resource != null && resource.data.parentId == request.auth.uid)
      );
      
      // Daily Logs subcollection
      match /daily_logs/{date} {
         allow read, write: if request.auth != null && get(/databases/$(database)/documents/children/$(childId)).data.parentId == request.auth.uid;
      }
    }
    
    // 3. Child-Related Data (Privacy Checked via direct parentId)
    // We allow read if doc doesn't exist (resource == null) so app can check for missing data.
    
    match /vaccines/{id} {
      allow read: if request.auth != null && (
        (resource == null) || 
        (resource != null && resource.data.parentId == request.auth.uid) ||
        (resource != null && get(/databases/$(database)/documents/children/$(resource.data.childId)).data.parentId == request.auth.uid)
      );
      allow write: if request.auth != null && (
        (resource == null && request.resource.data.parentId == request.auth.uid) ||
        (resource != null && resource.data.parentId == request.auth.uid)
      );
    }
    
    match /daily_checklist/{id} {
      allow read: if request.auth != null && (
        (resource == null) ||
        (resource != null && resource.data.parentId == request.auth.uid) ||
        (resource != null && get(/databases/$(database)/documents/children/$(resource.data.childId)).data.parentId == request.auth.uid)
      );
      allow write: if request.auth != null && (
        (resource == null && request.resource.data.parentId == request.auth.uid) ||
        (resource != null && resource.data.parentId == request.auth.uid)
      );
    }
    
    match /dental_appointments/{id} {
      allow read: if request.auth != null && (
        (resource == null) ||
        (resource != null && resource.data.parentId == request.auth.uid) ||
        (resource != null && get(/databases/$(database)/documents/children/$(resource.data.childId)).data.parentId == request.auth.uid)
      );
      allow write: if request.auth != null && (
        (resource == null && request.resource.data.parentId == request.auth.uid) ||
        (resource != null && resource.data.parentId == request.auth.uid)
      );
    }

    match /weekly_reports/{id} {
      allow read: if request.auth != null && (
        (resource == null) ||
        (resource != null && resource.data.parentId == request.auth.uid)
      );
      allow write: if request.auth != null && (
        (resource == null && request.resource.data.parentId == request.auth.uid) ||
        (resource != null && resource.data.parentId == request.auth.uid)
      );
    }
  }
}
