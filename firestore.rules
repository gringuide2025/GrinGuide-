rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 1. User & Parent Profiles (Owner-only)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /parents/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 2. Children (Only the parent who added them)
    match /children/{childId} {
      allow read, write: if request.auth != null && (
        resource == null || resource.data.parentId == request.auth.uid || request.resource.data.parentId == request.auth.uid
      );
      
      // Daily Logs subcollection
      match /daily_logs/{date} {
         allow read, write: if request.auth != null && get(/databases/$(database)/documents/children/$(childId)).data.parentId == request.auth.uid;
      }
    }
    
    // 3. Vaccines, Checklists, & Appointments (Privacy Checked)
    match /vaccines/{id} {
      allow read, write: if request.auth != null && (
        resource == null || get(/databases/$(database)/documents/children/$(resource.data.childId == null ? request.resource.data.childId : resource.data.childId)).data.parentId == request.auth.uid
      );
    }
    match /daily_checklist/{id} {
      allow read, write: if request.auth != null && (
        resource == null || get(/databases/$(database)/documents/children/$(resource.data.childId == null ? request.resource.data.childId : resource.data.childId)).data.parentId == request.auth.uid
      );
    }
    match /dental_appointments/{id} {
      allow read, write: if request.auth != null && (
        resource == null || get(/databases/$(database)/documents/children/$(resource.data.childId == null ? request.resource.data.childId : resource.data.childId)).data.parentId == request.auth.uid
      );
    }
  }
}
