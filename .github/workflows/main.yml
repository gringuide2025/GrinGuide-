name: GrinGuide Daily Notifications

on:
  schedule:
    # 1. Run for Habits at 11:30 PM IST (18:00 UTC)
    - cron: '0 18 * * *'
    # 2. Run for Food & Reminders at 12:30 AM IST (19:00 UTC)
    - cron: '0 19 * * *'
  
  workflow_dispatch:
    inputs:
      task_override:
        description: 'Manual task trigger (for testing)'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'morning_habits'
          - 'night_habits'
          - 'food'
          - 'vaccine'
          - 'dental'
          - 'weekly_report'
          - 'update_alert'

jobs:
  schedule_notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './backend/package-lock.json'

      - name: Install Dependencies
        working-directory: ./backend
        run: npm install

      - name: Check Workflow Lock
        working-directory: ./backend
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: node check_workflow_lock.js --task=daily_scheduler

      - name: Execute Split Scheduler Tasks
        working-directory: ./backend
        env:
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_REST_KEY: ${{ secrets.ONESIGNAL_REST_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: |
          MANUAL="${{ github.event.inputs.task_override }}"
          HOUR_UTC=$(date -u +%H)
          
          echo "üîÑ Running Scheduler..."
          echo "Current UTC Hour: $HOUR_UTC"
          
          if [[ "$MANUAL" != "" && "$MANUAL" != "all" ]]; then
            echo "üì¢ Manual Override Detected: $MANUAL"
            # Maintain existing manual triggers via scheduler.js
            if [[ "$MANUAL" == "morning_habits" ]]; then node scheduler.js --task=habits --type=morning_routine --time="7:00 AM"
            elif [[ "$MANUAL" == "night_habits" ]]; then node scheduler.js --task=habits --type=night_routine --time="9:00 PM"
            elif [[ "$MANUAL" == "food" ]]; then node scheduler.js --task=food --time="8:00 AM"
            elif [[ "$MANUAL" == "vaccine" ]]; then node scheduler.js --task=personal --category=vaccine
            elif [[ "$MANUAL" == "dental" ]]; then node scheduler.js --task=personal --category=dental
            elif [[ "$MANUAL" == "weekly_report" ]]; then node scheduler.js --task=weekly
            elif [[ "$MANUAL" == "update_alert" ]]; then node broadcast_update.js
            fi
          else
            # AUTO SCHEDULE (Based on Time)
            if [[ "$HOUR_UTC" == "18" ]]; then
              echo "üåô Trigger: 11:30 PM IST (Habits Only)"
              echo "   -> Pre-scheduling Morning Routine (7:00 AM) & Night Routine (9:00 PM)"
              node habits_master.js
            elif [[ "$HOUR_UTC" == "19" ]]; then
              echo "ü•ó Trigger: 12:30 AM IST (Food & Reminders)"
              echo "   -> Scheduling Super Food (8:00 AM IST)"
              echo "   -> Scheduling Vaccines (8:05 AM IST) & Dental (8:10 AM IST)"
              echo "   -> Scheduling Weekly Report (10:00 AM IST - if Sunday)"
              node food_master.js
              node reminders_master.js
            else
              echo "‚ö†Ô∏è Unknown Trigger Time ($HOUR_UTC UTC). Running ALL for safety."
              node habits_master.js
              node food_master.js
              node reminders_master.js
            fi
          fi
