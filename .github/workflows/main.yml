name: GrinGuide Daily Notifications

on:
  schedule:
    # Run ONCE daily at night (11:30 PM IST = 18:00 UTC)
    # Pre-schedules ALL notifications for the next day
    - cron: '0 18 * * *'
  
  workflow_dispatch:
    inputs:
      task_override:
        description: 'Manual task trigger (for testing)'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'morning_habits'
          - 'night_habits'
          - 'food'
          - 'vaccine'
          - 'dental'
          - 'weekly_report'

jobs:
  schedule_notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './backend/package-lock.json'

      - name: Install Dependencies
        working-directory: ./backend
        run: npm install

      - name: Check Workflow Lock
        working-directory: ./backend
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: node check_workflow_lock.js --task=daily_scheduler

      - name: Schedule Tomorrow's Notifications
        working-directory: ./backend
        env:
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_REST_KEY: ${{ secrets.ONESIGNAL_REST_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: |
          MANUAL="${{ github.event.inputs.task_override }}"
          DAY_OF_WEEK=$(date +%u)
          
          echo "üåô Nightly Scheduler Running..."
          echo "Current UTC Time: $(date -u)"
          echo "Manual Override: $MANUAL"
          
          if [[ "$MANUAL" == "morning_habits" ]]; then
            echo "üì¢ Manual: Scheduling Morning Habits only..."
            node scheduler.js --task=habits --type=morning_routine
          
          elif [[ "$MANUAL" == "night_habits" ]]; then
            echo "üì¢ Manual: Scheduling Night Habits only..."
            node scheduler.js --task=habits --type=night_routine
          
          elif [[ "$MANUAL" == "food" ]]; then
            echo "üì¢ Manual: Scheduling Food only..."
            node scheduler.js --task=food
          
          elif [[ "$MANUAL" == "vaccine" ]]; then
            echo "üì¢ Manual: Scheduling Vaccines only..."
            node scheduler.js --task=personal --category=vaccine
          
          elif [[ "$MANUAL" == "dental" ]]; then
            echo "üì¢ Manual: Scheduling Dental only..."
            node scheduler.js --task=personal --category=dental
          
          elif [[ "$MANUAL" == "weekly_report" ]]; then
            echo "üì¢ Manual: Scheduling Weekly Report..."
            node scheduler.js --task=weekly
          
          else
            # FULL DAILY SCHEDULE (default)
            echo "üìÖ Scheduling ALL notifications for tomorrow..."
            
            # Morning notifications (7:00 AM, 8:00 AM, 8:05 AM, 8:10 AM)
            echo "üåû Scheduling Morning Routine (7:00 AM IST)..."
            node scheduler.js --task=habits --type=morning_routine
            
            echo "ü•ó Scheduling Daily Food (8:00 AM IST)..."
            node scheduler.js --task=food
            
            echo "üíâ Scheduling Vaccine Reminders (8:05 AM IST)..."
            node scheduler.js --task=personal --category=vaccine
            
            echo "ü¶∑ Scheduling Dental Reminders (8:10 AM IST)..."
            node scheduler.js --task=personal --category=dental
            
            # Weekly report (only on Saturdays for Sunday delivery)
            if [ $DAY_OF_WEEK -eq 6 ]; then
              echo "üìä Scheduling Weekly Report (Sunday 10:00 AM IST)..."
              node scheduler.js --task=weekly
            else
              echo "‚è≠Ô∏è Skipping Weekly Report (only runs Saturday night for Sunday delivery)"
            fi
            
            # Night notification (9:00 PM)
            echo "üåô Scheduling Night Routine (9:00 PM IST)..."
            node scheduler.js --task=habits --type=night_routine
            
            echo "‚úÖ All notifications scheduled successfully!"
          fi
