name: GrinGuide Daily Notifications

on:
  schedule:
    # 12:10 AM IST (18:40 UTC) - Unified Daily Scheduler
    - cron: '40 18 * * *'
  
  workflow_dispatch:
    inputs:
      task_override:
        description: 'Manual task trigger (for testing)'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'morning_habits'
          - 'night_habits'
          - 'food'
          - 'vaccine'
          - 'dental'
          - 'weekly_report'
          - 'update_alert'

jobs:
  schedule_notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './backend/package-lock.json'

      - name: Install Dependencies
        working-directory: ./backend
        run: npm install

      - name: Check Workflow Lock
        working-directory: ./backend
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: node check_workflow_lock.js --task=daily_scheduler

      - name: Execute Daily Master Scheduler
        working-directory: ./backend
        env:
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_REST_KEY: ${{ secrets.ONESIGNAL_REST_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: |
          MANUAL="${{ github.event.inputs.task_override }}"
          
          if [[ "$MANUAL" != "" && "$MANUAL" != "all" ]]; then
            echo "ðŸ“¢ Manual Override Detected: $MANUAL"
            if [[ "$MANUAL" == "morning_habits" ]]; then node scheduler.js --task=habits --type=morning_routine --time="7:00 AM"
            elif [[ "$MANUAL" == "night_habits" ]]; then node scheduler.js --task=habits --type=night_routine --time="9:00 PM"
            elif [[ "$MANUAL" == "food" ]]; then node scheduler.js --task=food --time="8:00 AM"
            elif [[ "$MANUAL" == "vaccine" ]]; then node scheduler.js --task=personal --category=vaccine
            elif [[ "$MANUAL" == "dental" ]]; then node scheduler.js --task=personal --category=dental
            elif [[ "$MANUAL" == "weekly_report" ]]; then node scheduler.js --task=weekly
            elif [[ "$MANUAL" == "update_alert" ]]; then node broadcast_update.js
            fi
          else
            echo "ðŸš€ Executing Unified Master Schedule (12:10 AM IST)"
            echo "   -> Morning Routine (7:00 AM IST)"
            echo "   -> Super Food (8:00 AM IST)"
            echo "   -> Vaccines/Dental (8:05/8:10 AM IST)"
            echo "   -> Weekly Report (10:00 AM IST - Sundays)"
            echo "   -> Night Routine (9:00 PM IST)"
            node daily_master.js
          fi
